{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-search"></i> –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π</h1>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π</h5>
                        <h2 class="mb-0">{{ event_stats.total }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">–û—Ç–∫—Ä—ã—Ç–∏—è</h5>
                        <h2 class="mb-0">{{ event_stats.open }}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h5 class="card-title">–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h5>
                        <h5 class="mb-0"><span id="monitor-status">üü¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω</span></h5>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π –æ—Ç–∫—Ä—ã—Ç–∏—è</h5>
                <div>
                    <button id="refresh-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button id="clear-filter" class="btn btn-secondary btn-sm ms-2">
                        <i class="fas fa-filter"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">
                        <strong>–û—à–∏–±–∫–∞:</strong> {{ error }}
                    </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-md-3">
                        <input type="date" id="date-filter" class="form-control" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ">
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="search-filter" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–π–ª—É –∏–ª–∏ IP">
                    </div>
                    <div class="col-md-3">
                        <select id="severity-filter" class="form-select">
                            <option value="all">–í—Å–µ —Å–æ–±—ã—Ç–∏—è</option>
                            <option value="open">–û—Ç–∫—Ä—ã—Ç–∏—è</option>
                            <option value="delete">–£–¥–∞–ª–µ–Ω–∏—è</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="user-filter" class="form-select">
                            <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                            {% set users = [] %}
                            {% for event in events %}
                                {% if event.username and event.username not in users %}
                                    {% set _ = users.append(event.username) %}
                                    <option value="{{ event.username }}">{{ event.username }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="events-table">
                        <thead>
                            <tr>
                                <th>–í—Ä–µ–º—è</th>
                                <th>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è</th>
                                <th>–§–∞–π–ª</th>
                                <th>ID —Ç–æ–∫–µ–Ω–∞</th>
                                <th>IP –∞–¥—Ä–µ—Å</th>
                                <th>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è</th>
                                <th>–ü—Ä–æ—Ü–µ—Å—Å</th>
                                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            </tr>
                        </thead>
                        <tbody id="events-body">
                            {% if events %}
                                {% for event in events %}
                                <tr class="event-row" data-type="{{ event.event_type }}" data-guid="{{ event.guid }}" style="cursor: pointer;">
                                    <td>
                                        <small>{{ event.triggered_at }}</small>
                                    </td>
                                    <td>
                                        {% if event.event_type == 'open' %}
                                            <span class="badge bg-warning">üìñ –û—Ç–∫—Ä—ã—Ç–∏–µ</span>
                                        {% elif event.event_type == 'delete' %}
                                            <span class="badge bg-danger">üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ</span>
                                        {% else %}
                                            <span class="badge bg-info">‚ÑπÔ∏è {{ event.event_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ event.location.split('/')[-1] }}</small><br>
                                        <small class="text-muted">{{ event.location[:50] }}{% if event.location|length > 50 %}...{% endif %}</small>
                                    </td>
                                    <td>
                                        <code class="small">{{ event.guid[:8] }}...</code>
                                    </td>
                                    <td>
                                        {% if event.ip %}
                                            <code class="small">{{ event.ip }}</code>
                                        {% else %}
                                            <span class="text-muted small">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if event.city and event.country %}
                                            <small>{{ event.city }}, {{ event.country }}</small>
                                        {% else %}
                                            <span class="text-muted small">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if event.process_name %}
                                            <small>{{ event.process_name }}</small><br>
                                            <small class="text-muted">PID: {{ event.process_pid }}</small>
                                        {% else %}
                                            <span class="text-muted small">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ event.username or 'N/A' }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <small class="text-muted" id="event-count">–ü–æ–∫–∞–∑–∞–Ω–æ {{ events|length }} —Å–æ–±—ã—Ç–∏–π</small>
                    </div>
                    <div>
                        <button id="load-more" class="btn btn-outline-secondary btn-sm" style="display: none;">
                            <i class="fas fa-plus"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –¥–Ω—è–º</h5>
            </div>
            <div class="card-body">
                <canvas id="eventsChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π —Å–æ–±—ã—Ç–∏—è -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="eventDetailsModalLabel">
                    <i class="fas fa-info-circle me-2"></i>–î–µ—Ç–∞–ª–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>
            <div class="modal-body" id="event-details-content">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–Ω—Ü–∏–¥–µ–Ω—Ç–µ...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>–ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button type="button" class="btn btn-primary" id="copy-token-id">
                    <i class="fas fa-copy me-1"></i>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let eventsChart = null;
    let currentPage = 1;
    let currentTokenGuid = null;
    let allEventsData = [];
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–∫–µ–Ω–∞
    function loadTokenDetails(tokenGuid) {
        if (!tokenGuid) return;
        
        currentTokenGuid = tokenGuid;
        const modalContent = document.getElementById('event-details-content');
        
        modalContent.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–Ω—Ü–∏–¥–µ–Ω—Ç–µ...</p>
            </div>
        `;
        
        fetch(`/monitoring/token/${tokenGuid}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const token = data.token;
                    displayTokenDetails(token);
                } else {
                    modalContent.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h6>
                            <p class="mb-0">${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–∫–µ–Ω–∞:', error);
                modalContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h6>
                        <p class="mb-0">${error.message || '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞'}</p>
                    </div>
                `;
            });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Ç–æ–∫–µ–Ω–∞
    function displayTokenDetails(token) {
        const modalContent = document.getElementById('event-details-content');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ —Ü–≤–µ—Ç –±–µ–π–¥–∂–∞
        let eventTypeBadge = '';
        if (token.event_type === 'open') {
            eventTypeBadge = '<span class="badge bg-warning">üìñ –û—Ç–∫—Ä—ã—Ç–∏–µ</span>';
        } else if (token.event_type === 'delete') {
            eventTypeBadge = '<span class="badge bg-danger">üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ</span>';
        } else {
            eventTypeBadge = `<span class="badge bg-info">‚ÑπÔ∏è ${token.event_type || 'unknown'}</span>`;
        }
        
        let geoHtml = '<span class="text-muted">N/A</span>';
        if (token.city && token.city !== 'N/A' && token.city !== 'Unknown') {
            geoHtml = `${token.city}, ${token.country}`;
            if (token.latitude && token.longitude && token.latitude !== 'N/A' && token.longitude !== 'N/A') {
                geoHtml += `<br><small class="text-muted">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${token.latitude}, ${token.longitude}</small>`;
            }
        }
        
        let processHtml = '<span class="text-muted">N/A</span>';
        if (token.process_name && token.process_name !== 'N/A') {
            processHtml = `${token.process_name}<br><small class="text-muted">PID: ${token.process_pid}</small>`;
        }
        
        let ipHtml = '<span class="text-muted">N/A</span>';
        if (token.ip_address && token.ip_address !== 'N/A') {
            ipHtml = `<code>${token.ip_address}</code>`;
        }
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ª–æ–≤—É—à–∫–∞—Ö
        let trapsHtml = '<span class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';
        if (token.location) {
            const fileName = token.location.split('/').pop();
            const baseName = fileName.split('.').slice(0, -1).join('.');
            const ext = fileName.split('.').pop();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ–≤—É—à–∫–∏
            fetch('/folder-info?path=' + encodeURIComponent(token.location))
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.traps_count !== undefined) {
                        const trapsCountElement = document.getElementById('traps-count');
                        if (trapsCountElement) {
                            trapsCountElement.textContent = data.traps_count;
                        }
                    }
                })
                .catch(console.error);
        }
        
        const html = `
            <div class="row">
                <div class="col-md-6">
                    <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong><i class="fas fa-fingerprint me-2 text-primary"></i>ID —Ç–æ–∫–µ–Ω–∞:</strong><br>
                            <code class="d-block mt-1 p-2 bg-light rounded">${token.guid}</code>
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-calendar-alt me-2 text-primary"></i>–°–æ–∑–¥–∞–Ω:</strong><br>
                            <span>${token.created_at}</span>
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-clock me-2 text-primary"></i>–í—Ä–µ–º—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è:</strong><br>
                            <span>${token.triggered_at}</span>
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-exclamation-triangle me-2 text-primary"></i>–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:</strong><br>
                            ${eventTypeBadge}
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>–°–µ—Ç–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong><i class="fas fa-network-wired me-2 text-primary"></i>IP –∞–¥—Ä–µ—Å:</strong><br>
                            ${ipHtml}
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-globe me-2 text-primary"></i>–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:</strong><br>
                            ${geoHtml}
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-shield-alt me-2 text-primary"></i>–°–æ–∑–¥–∞–Ω–æ –ª–æ–≤—É—à–µ–∫:</strong><br>
                            <span id="traps-count">0</span> –∏–∑ 2 –≤–æ–∑–º–æ–∂–Ω—ã—Ö
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong><i class="fas fa-tasks me-2 text-primary"></i>–ü—Ä–æ—Ü–µ—Å—Å:</strong><br>
                            ${processHtml}
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-user me-2 text-primary"></i>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                            <span>${token.username || 'N/A'}</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6>–§–∞–π–ª–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong><i class="fas fa-file me-2 text-primary"></i>–§–∞–π–ª:</strong><br>
                            <span class="d-block mt-1">${token.location.split('/').pop()}</span>
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-folder me-2 text-primary"></i>–ü–æ–ª–Ω—ã–π –ø—É—Ç—å:</strong><br>
                            <small class="d-block mt-1 text-muted">${token.location}</small>
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-database me-2 text-primary"></i>–¢–∏–ø —Ç–æ–∫–µ–Ω–∞:</strong><br>
                            <span class="badge bg-info">${token.type}</span>
                        </li>
                        <li class="mb-2">
                            <strong><i class="fas fa-check-circle me-2 text-primary"></i>–°—Ç–∞—Ç—É—Å:</strong><br>
                            <span class="badge ${token.triggered ? 'bg-danger' : 'bg-success'}">
                                ${token.triggered ? '–°—Ä–∞–±–æ—Ç–∞–ª' : '–ê–∫—Ç–∏–≤–µ–Ω'}
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="alert alert-info mt-3">
                <h6><i class="fas fa-info-circle me-2"></i>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</h6>
                <p class="mb-0">–ü—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞-–ª–æ–≤—É—à–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–æ 2 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤-–ª–æ–≤—É—à–µ–∫ –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤.</p>
            </div>
        `;
        
        modalContent.innerHTML = html;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è ID —Ç–æ–∫–µ–Ω–∞
    function copyTokenId() {
        if (!currentTokenGuid) return;
        
        navigator.clipboard.writeText(currentTokenGuid)
            .then(() => {
                const copyBtn = document.getElementById('copy-token-id');
                const originalHtml = copyBtn.innerHTML;
                
                copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                copyBtn.classList.remove('btn-primary');
                copyBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHtml;
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-primary');
                }, 2000);
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID —Ç–æ–∫–µ–Ω–∞');
            });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π
    function loadEvents(page = 1, forceRefresh = false) {
        if (forceRefresh || page === 1) {
            currentPage = 1;
        }
        
        fetch(`/monitoring/events?page=${currentPage}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (page === 1) {
                        allEventsData = data.events;
                    } else {
                        allEventsData = allEventsData.concat(data.events);
                    }
                    updateEventsTable(allEventsData);
                    updateEventCount(allEventsData.length, data.count);
                    updateChart(allEventsData);
                    
                    if (data.events.length >= 50) {
                        document.getElementById('load-more').style.display = 'block';
                    } else {
                        document.getElementById('load-more').style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ–±—ã—Ç–∏–π
    function updateEventsTable(events) {
        const tbody = document.getElementById('events-body');
        if (events.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">–°–æ–±—ã—Ç–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        events.forEach(event => {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –±–µ–π–¥–∂
            let eventTypeBadge = '';
            if (event.event_type === 'open') {
                eventTypeBadge = '<span class="badge bg-warning">üìñ –û—Ç–∫—Ä—ã—Ç–∏–µ</span>';
            } else if (event.event_type === 'delete') {
                eventTypeBadge = '<span class="badge bg-danger">üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ</span>';
            } else {
                eventTypeBadge = `<span class="badge bg-info">‚ÑπÔ∏è ${event.event_type || 'unknown'}</span>`;
            }
            
            const fileName = event.location.split('/').pop();
            const shortLocation = event.location.length > 50 ? 
                event.location.substring(0, 50) + '...' : event.location;
            
            const ipHtml = event.ip ? `<code class="small">${event.ip}</code>` : '<span class="text-muted small">N/A</span>';
            const geoHtml = event.city && event.country ? `<small>${event.city}, ${event.country}</small>` : '<span class="text-muted small">N/A</span>';
            const processHtml = event.process_name ? `<small>${event.process_name}</small><br><small class="text-muted">PID: ${event.process_pid}</small>` : '<span class="text-muted small">N/A</span>';
            
            html += `
                <tr class="event-row" data-type="${event.event_type}" data-guid="${event.guid}" style="cursor: pointer;">
                    <td><small>${event.triggered_at}</small></td>
                    <td>${eventTypeBadge}</td>
                    <td>
                        <small>${fileName}</small><br>
                        <small class="text-muted">${shortLocation}</small>
                    </td>
                    <td><code class="small">${event.guid.substring(0, 8)}...</code></td>
                    <td>${ipHtml}</td>
                    <td>${geoHtml}</td>
                    <td>${processHtml}</td>
                    <td><small>${event.username || 'N/A'}</small></td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        attachEventListeners();
        filterEvents(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π
    function updateEventCount(visibleCount, totalCount) {
        const countElement = document.getElementById('event-count');
        if (visibleCount === totalCount) {
            countElement.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${visibleCount} —Å–æ–±—ã—Ç–∏–π`;
        } else {
            countElement.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${visibleCount} –∏–∑ ${totalCount} —Å–æ–±—ã—Ç–∏–π`;
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π
    function filterEvents() {
        const dateFilter = document.getElementById('date-filter').value;
        const searchFilter = document.getElementById('search-filter').value.toLowerCase();
        const severityFilter = document.getElementById('severity-filter').value;
        const userFilter = document.getElementById('user-filter').value;
        
        let visibleCount = 0;
        
        document.querySelectorAll('.event-row').forEach(row => {
            let show = true;
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
            if (dateFilter) {
                const eventDate = row.cells[0].textContent.substring(0, 10);
                if (eventDate !== dateFilter) {
                    show = false;
                }
            }
            
            // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
            if (searchFilter) {
                const rowText = row.textContent.toLowerCase();
                if (!rowText.includes(searchFilter)) {
                    show = false;
                }
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
            if (severityFilter !== 'all') {
                const eventType = row.dataset.type;
                if (eventType !== severityFilter) {
                    show = false;
                }
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            if (userFilter !== 'all') {
                const username = row.cells[7].textContent.trim();
                if (username !== userFilter) {
                    show = false;
                }
            }
            
            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤–∏–¥–∏–º—ã—Ö —Å–æ–±—ã—Ç–∏–π
        updateEventCount(visibleCount, allEventsData.length);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–≤—è–∑–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function attachEventListeners() {
        document.querySelectorAll('.event-row').forEach(row => {
            row.addEventListener('click', function() {
                const tokenGuid = this.dataset.guid;
                if (tokenGuid) {
                    loadTokenDetails(tokenGuid);
                    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
                    modal.show();
                }
            });
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function updateChart(events) {
        const ctx = document.getElementById('eventsChart').getContext('2d');
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ –¥–Ω—è–º
        const eventsByDay = {};
        const eventTypes = {};
        
        events.forEach(event => {
            const date = event.triggered_at.substring(0, 10); // YYYY-MM-DD
            if (!eventsByDay[date]) {
                eventsByDay[date] = { open: 0, delete: 0, other: 0 };
            }
            
            const eventType = event.event_type || 'other';
            if (eventTypes[eventType] === undefined) {
                eventTypes[eventType] = Object.keys(eventTypes).length;
            }
            
            if (eventType === 'open') {
                eventsByDay[date].open++;
            } else if (eventType === 'delete') {
                eventsByDay[date].delete++;
            } else {
                eventsByDay[date].other++;
            }
        });
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
        const dates = Object.keys(eventsByDay).sort().slice(-7);
        
        if (dates.length === 0) {
            // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫
            if (eventsChart) {
                eventsChart.destroy();
            }
            
            eventsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
                    datasets: [
                        {
                            label: '–û—Ç–∫—Ä—ã—Ç–∏—è',
                            data: [0],
                            borderColor: 'rgb(255, 193, 7)',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: '–£–¥–∞–ª–µ–Ω–∏—è',
                            data: [0],
                            borderColor: 'rgb(220, 53, 69)',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –¥–Ω—è–º'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π'
                            }
                        }
                    }
                }
            });
            return;
        }
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        const openData = dates.map(date => eventsByDay[date]?.open || 0);
        const deleteData = dates.map(date => eventsByDay[date]?.delete || 0);
        const otherData = dates.map(date => eventsByDay[date]?.other || 0);
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const formattedDates = dates.map(date => {
            const [year, month, day] = date.split('-');
            return `${day}.${month}`;
        });
        
        if (eventsChart) {
            eventsChart.destroy();
        }
        
        eventsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedDates,
                datasets: [
                    {
                        label: '–û—Ç–∫—Ä—ã—Ç–∏—è',
                        data: openData,
                        borderColor: 'rgb(255, 193, 7)',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.1
                    },
                    {
                        label: '–£–¥–∞–ª–µ–Ω–∏—è',
                        data: deleteData,
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ –¥–Ω—è–º'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π'
                        }
                    }
                }
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
    function showError(message) {
        const eventsBody = document.getElementById('events-body');
        if (eventsBody) {
            eventsBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${message}
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞
        updateChart({{ events|tojson|safe }});
        
        // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        attachEventListeners();
        
        // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è ID
        document.getElementById('copy-token-id').addEventListener('click', copyTokenId);
        
        // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        document.getElementById('refresh-btn').addEventListener('click', function() {
            const btn = this;
            const originalHtml = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            btn.disabled = true;
            
            setTimeout(() => {
                loadEvents(1, true);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }, 500);
        });
        
        // –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –µ—â–µ
        document.getElementById('load-more').addEventListener('click', function() {
            currentPage++;
            loadEvents(currentPage);
        });
        
        // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        document.getElementById('clear-filter').addEventListener('click', function() {
            document.getElementById('date-filter').value = '';
            document.getElementById('search-filter').value = '';
            document.getElementById('severity-filter').value = 'all';
            document.getElementById('user-filter').value = 'all';
            filterEvents();
        });
        
        // –§–∏–ª—å—Ç—Ä—ã
        document.getElementById('date-filter').addEventListener('change', filterEvents);
        document.getElementById('search-filter').addEventListener('input', filterEvents);
        document.getElementById('severity-filter').addEventListener('change', filterEvents);
        document.getElementById('user-filter').addEventListener('change', filterEvents);
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            loadEvents(1, true);
        }, 60000);
        
        // –°—Ç–∞—Ç—É—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        setInterval(() => {
            const status = document.getElementById('monitor-status');
            const now = new Date();
            status.innerHTML = `üü¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω (${now.toLocaleTimeString()})`;
        }, 1000);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        allEventsData = {{ events|tojson|safe }};
    });
</script>
{% endblock %}